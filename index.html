<script>
  // Initialize Teams SDK
  microsoftTeams.initialize();

  // 1. Parse sys_id from URL
  const params = new URLSearchParams(window.location.search);
  const sysId = params.get('sys_id');
  if (!sysId) {
    document.getElementById('loading').innerText = "Error: No incident id provided.";
  }

  // 2. Get Azure AD SSO token silently
  microsoftTeams.authentication.getAuthToken().then(async (token) => {
      console.log("Got Teams token:", token);
      // 3. Call backend to get incident details
      const resp = await fetch(`/api/incident?sys_id=${sysId}`, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!resp.ok) {
        document.getElementById('loading').innerText = "Failed to load incident.";
        return;
      }
      const data = await resp.json();
      console.log("Incident data:", data);
      // 4. Populate form fields
      document.getElementById('number').value = data.result.number;
      document.getElementById('short_description').value = data.result.short_description;
      document.getElementById('state').value = data.result.state;
      // ... populate other fields ...
      document.getElementById('loading').style.display = 'none';
      document.getElementById('incidentForm').style.display = 'block';
    })
    .catch(err => {
      console.error("Error getting auth token:", err);
      document.getElementById('loading').innerText = "Authentication error. Please ensure SSO is configured.";
    });

  // 5. Save button handler
  document.getElementById('saveBtn').onclick = async () => {
    document.getElementById('result').innerText = ""; // clear old result
    // Gather edited values
    const updated = {
      sys_id: sysId,
      short_description: document.getElementById('short_description').value,
      state: document.getElementById('state').value
      // ... any other updatable fields ...
    };
    // Get token (still cached, getAuthToken will reuse cached token until expiration[1](https://learn.microsoft.com/en-us/microsoft-365-copilot/extensibility/adaptive-card-dialog-box))
    try {
      const token = await microsoftTeams.authentication.getAuthToken();
      const resp = await fetch(`/api/incident`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(updated)
      });
      if (!resp.ok) throw new Error(resp.statusText);
      document.getElementById('result').innerText = "âœ… Incident updated successfully in ServiceNow.";
    } catch (error) {
      console.error("Update failed:", error);
      document.getElementById('result').style.color = 'red';
      document.getElementById('result').innerText = "Failed to update incident.";
    }
  };
</script>