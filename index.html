<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ServiceNow Incident Editor</title>
  <!-- Teams SDK for SSO: -->
  https://statics.teams.cdn.office.net/sdk/v2.0.0/js/sdk.min.js
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #0078D4; }  /* Blue header */
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, textarea { width: 100%; padding: 5px; margin-bottom: 10px; }
    #loading { color: gray; font-style: italic; }
    #result { margin-top: 15px; font-weight: bold; }
    #result.error { color: red; }
  </style>
</head>
<body>
  <h2>Edit ServiceNow Incident</h2>
  <div id="loading">Loading incident details...</div>
  
  <form id="incidentForm" style="display:none;">
    <label>Number:
      <input id="number" type="text" disabled />
    </label>
    <label>Short Description:
      <textarea id="short_description"></textarea>
    </label>
    <label>State:
      <input id="state" type="text" />
    </label>
    <!-- Additional fields can be added here -->
    <button type="button" id="saveBtn">ðŸ’¾ Save Changes</button>
  </form>
  
  <div id="result"></div>
  
  <script>
    // Initialize Microsoft Teams SDK (required for authentication to work)
    microsoftTeams.initialize();

    // Get the 'sys_id' from URL query parameters
    const params = new URLSearchParams(window.location.search);
    const sysId = params.get('sys_id');
    if (!sysId) {
      document.getElementById('loading').innerText = "Error: No incident id provided.";
      throw new Error("No sys_id parameter");
    }

    // 1. Get Azure AD token silently via Teams SSO
    microsoftTeams.authentication.getAuthToken().then(async (aadToken) => {
      console.log("Got Azure AD token.");
      // 2. Use the token to call backend API and get incident details
      const resp = await fetch(`/api/incident?sys_id=${sysId}`, {
        headers: { 'Authorization': `Bearer ${aadToken}` }
      });
      if (!resp.ok) throw new Error("Incident fetch failed: " + resp.status);
      const data = await resp.json();
      // 3. Populate form with incident data
      document.getElementById('number').value = data.result.number || "";
      document.getElementById('short_description').value = data.result.short_description || "";
      document.getElementById('state').value = data.result.state || "";
      // Show the form, hide the loading text
      document.getElementById('loading').style.display = 'none';
      document.getElementById('incidentForm').style.display = 'block';
    }).catch(err => {
      console.error("SSO getAuthToken failed", err);
      document.getElementById('loading').innerText = "Authentication error. Please sign in.";
      // In case of error, you might handle interactive auth here, but for demo we assume SSO works.
    });

    // Save button handler - send updates to backend
    document.getElementById('saveBtn').onclick = async () => {
      const resultDiv = document.getElementById('result');
      resultDiv.classList.remove('error');
      resultDiv.innerText = "Saving...";
      const updatePayload = {
        sys_id: sysId,
        short_description: document.getElementById('short_description').value,
        state: document.getElementById('state').value
      };
      try {
        const aadToken = await microsoftTeams.authentication.getAuthToken();
        const response = await fetch(`/api/incident`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${aadToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatePayload)
        });
        if (!response.ok) throw new Error("Update failed: " + response.status);
        resultDiv.innerText = "âœ… Incident updated successfully.";
      } catch (error) {
        console.error(error);
        resultDiv.classList.add('error');
        resultDiv.innerText = "Failed to update incident.";
      }
    };
  </script>
</body>
</html>